services:
  t1:
    container_name: t1
    build:
      dockerfile: docker/t1.Dockerfile
    volumes:
      - ./out:/app/code/out/
    working_dir: /app/code
    gpus: all
    profiles: ["t1", "arno", "test"]

  t2:
    container_name: t2
    build:
      dockerfile: docker/t2.Dockerfile
    volumes:
      - ./out:/app/code/out/
    working_dir: /app/code
    gpus: all
    profiles: ["t2", "arno", "test"]

  t3:
    container_name: t3
    build:
      dockerfile: docker/t3.Dockerfile
    volumes:
      - ./out:/app/code/out/
    env_file:
      - .env
    profiles: ["t3", "test", "full_local"]
    depends_on:
      api:
        condition: service_healthy
    networks:
      - pipeline
  
  t3_eval:
    container_name: t3_eval
    build:
      dockerfile: docker/t3_eval.Dockerfile
    volumes:
      - ./out:/app/code/out/
    env_file:
      - .env
    profiles: ["t3_eval", "full_local_eval"]
    depends_on:
      api:
        condition: service_healthy
    networks:
      - pipeline

  benchmark:
    container_name: benchmark
    build:
      dockerfile: docker/benchmark.Dockerfile
    volumes:
      - ./out:/app/code/out/
    working_dir: /app/code
    depends_on:
      t1:
        condition: service_completed_successfully
      t2:
        condition: service_completed_successfully
    gpus: all
    profiles: ["benchmark", "arno"]

  api:
    container_name: api
    build:
      dockerfile: docker/api.Dockerfile
    ports:
      - "8000:8000"
    gpus: all
    env_file:
      - .env
    profiles: ["api", "full_local", "full_local_eval"]
    volumes:
      - hf_cache:/root/.cache/huggingface/
      - model_cache:/app/model/
    networks:
      - pipeline
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  tuner:
    container_name: tuner
    build:
      dockerfile: docker/tuner.Dockerfile
    volumes:
      - ./out:/app/out/
      - hf_cache:/root/.cache/huggingface/
    working_dir: /app
    gpus: all
    profiles: ["tune"]
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc: 16384
      stack: 67108864
      memlock:
        soft: -1
        hard: -1
    ipc: host

volumes:
  hf_cache:
  model_cache:

networks:
  pipeline:
    driver: bridge
